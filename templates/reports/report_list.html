{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block extra_css %}
<style>
    .reports-page .card-header { gap: 12px; flex-wrap: wrap; align-items: center; }
    .reports-page .reports-title { display:flex; align-items:center; gap:10px; line-height:1.2; }
    .reports-page .reports-title i { color: var(--accent-color); }
    .reports-page .reports-subtitle { color: var(--text-muted); font-size: 11px; margin-top: 2px; }
    .reports-page .reports-toolbar { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; justify-content: flex-end; }
    .reports-page .reports-search { position: relative; min-width: 260px; max-width: 460px; flex: 1; }
    .reports-page .reports-search i { position:absolute; left:10px; top:50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; pointer-events:none; }
    .reports-page .reports-search input { padding-left: 30px; height: 32px; }
    .reports-page .reports-mini { color: var(--text-muted); font-size: 10px; white-space: nowrap; }

    .reports-page .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 14px; }
    .reports-page .stat-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(64,64,64,0.35); border-radius: 12px; padding: 14px; display:flex; gap: 12px; align-items:center; }
    .reports-page .stat-icon { background: rgba(0, 212, 255, 0.16); border: 1px solid rgba(0, 212, 255, 0.25); color: var(--accent-color); width: 40px; height: 40px; border-radius: 999px; display:flex; align-items:center; justify-content:center; }
    .reports-page .stat-num { font-size: 20px; font-weight: 900; margin: 0; }
    .reports-page .stat-label { font-size: 11px; color: var(--text-secondary); margin: 0; }

    .reports-page .table-wrap { border: 1px solid rgba(64,64,64,0.35); border-radius: 12px; overflow: hidden; }
    .reports-page table { margin: 0; }
    .reports-page thead th { position: sticky; top: 0; z-index: 5; background: var(--header-bg); font-size: 10px; letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap; }
    .reports-page tbody tr:hover { background: rgba(0, 212, 255, 0.06); }
    .reports-page .patient-name { font-weight: 800; color: var(--text-primary); }
    .reports-page .patient-id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; color: var(--text-muted); font-size: 10px; }
    .reports-page .badge-status { padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 800; border: 1px solid transparent; }
    .reports-page .badge-status.draft { background: rgba(156,163,175,0.12); border-color: rgba(156,163,175,0.25); color: #cbd5e1; }
    .reports-page .badge-status.preliminary { background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25); color: #fbbf24; }
    .reports-page .badge-status.final { background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.25); color: #34d399; }
    .reports-page .badge-status.amended { background: rgba(0,212,255,0.10); border-color: rgba(0,212,255,0.22); color: var(--accent-color); }

    .reports-page .btn-mini { padding: 6px 10px; font-size: 11px; }
    .reports-page .actions { display:flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    @media (max-width: 992px) { .reports-page .actions { justify-content: flex-start; } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 reports-page">
    <div class="card">
        <div class="card-header">
            <div class="reports-title">
                <i class="fas fa-file-medical" aria-hidden="true"></i>
                <div>
                    <div style="font-weight:700;">Reports</div>
                    <div class="reports-subtitle">Search, edit, and print radiology reports</div>
                </div>
            </div>

            <form class="reports-toolbar" method="get" action="{% url 'reports:report_list' %}">
                <div class="reports-search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input id="searchInput" class="form-control form-control-sm" type="text" name="search"
                           value="{{ search_query|default:'' }}"
                           placeholder="Patient, accession, radiologistâ€¦" autocomplete="off">
                </div>
                <select id="statusFilter" class="form-control form-control-sm" name="status" style="height:32px; min-width: 160px;">
                    <option value="" {% if not status_filter %}selected{% endif %}>All status</option>
                    <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="preliminary" {% if status_filter == 'preliminary' %}selected{% endif %}>Preliminary</option>
                    <option value="final" {% if status_filter == 'final' %}selected{% endif %}>Final</option>
                    <option value="amended" {% if status_filter == 'amended' %}selected{% endif %}>Amended</option>
                </select>
                <select id="modalityFilter" class="form-control form-control-sm" name="modality" style="height:32px; min-width: 160px;">
                    <option value="" {% if not modality_filter %}selected{% endif %}>All modalities</option>
                    <option value="CT" {% if modality_filter == 'CT' %}selected{% endif %}>CT</option>
                    <option value="MR" {% if modality_filter == 'MR' %}selected{% endif %}>MR</option>
                    <option value="XR" {% if modality_filter == 'XR' %}selected{% endif %}>X-Ray</option>
                    <option value="US" {% if modality_filter == 'US' %}selected{% endif %}>Ultrasound</option>
                </select>
                <button class="btn-control btn-mini" type="submit"><i class="fas fa-filter"></i> Apply</button>
                <a class="btn-control btn-mini" href="{% url 'reports:report_list' %}"><i class="fas fa-undo"></i> Reset</a>
            </form>
        </div>

        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-file-medical" aria-hidden="true"></i></div>
                    <div>
                        <p class="stat-num">{{ total_reports|default:0 }}</p>
                        <p class="stat-label">Total reports</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-edit" aria-hidden="true"></i></div>
                    <div>
                        <p class="stat-num">{{ draft_reports|default:0 }}</p>
                        <p class="stat-label">Draft</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock" aria-hidden="true"></i></div>
                    <div>
                        <p class="stat-num">{{ pending_reports|default:0 }}</p>
                        <p class="stat-label">Preliminary</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle" aria-hidden="true"></i></div>
                    <div>
                        <p class="stat-num">{{ final_reports|default:0 }}</p>
                        <p class="stat-label">Final</p>
                    </div>
                </div>
            </div>

            <div class="table-responsive table-wrap">
                <table class="table table-dark table-striped align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Body Part</th>
                            <th>Radiologist</th>
                            <th>Status</th>
                            <th>Report Date</th>
                            <th style="text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if reports %}
                        {% for report in reports %}
                        <tr>
                            <td>
                                <div class="patient-name">{{ report.study.patient.full_name }}</div>
                                <div class="patient-id">{{ report.study.patient.patient_id }}</div>
                            </td>
                            <td class="patient-id">{{ report.study.study_date|date:"M d, Y" }}</td>
                            <td><span class="modality-badge">{{ report.study.modality.code }}</span></td>
                            <td>{{ report.study.body_part_examined|default:"-" }}</td>
                            <td>{{ report.radiologist.get_full_name|default:report.radiologist.username }}</td>
                            <td><span class="badge-status {{ report.status }}">{{ report.get_status_display }}</span></td>
                            <td class="patient-id">{{ report.report_date|date:"M d, Y H:i" }}</td>
                            <td style="text-align:right;">
                                <div class="actions">
                                    <a href="{% url 'reports:write_report' report.study.id %}" class="btn-control btn-mini" title="View/Edit Report">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <a href="{% url 'reports:print_report' report.study.id %}" class="btn-control btn-mini" title="Print Report" target="_blank">
                                        <i class="fas fa-print"></i> Print
                                    </a>
                                    <a href="{% url 'reports:export_report_pdf' report.study.id %}" class="btn-control btn-mini" title="Download PDF">
                                        <i class="fas fa-download"></i> PDF
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align:center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-file-medical" style="font-size: 44px; opacity: 0.25; margin-bottom: 10px; display:block;" aria-hidden="true"></i>
                                <div style="font-size: 14px; margin-bottom: 6px; font-weight: 800;">No reports found</div>
                                <div style="font-size: 12px;">Try adjusting your filters, or create a report from a study.</div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        function ready(fn) {
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
            else fn();
        }
        ready(function () {
            var form = document.querySelector('.reports-toolbar');
            var search = document.getElementById('searchInput');
            var status = document.getElementById('statusFilter');
            var modality = document.getElementById('modalityFilter');
            if (!form) return;

            // submit on select change
            if (status) status.addEventListener('change', function () { form.submit(); });
            if (modality) modality.addEventListener('change', function () { form.submit(); });

            // debounce search submit
            var t;
            if (search) {
                search.addEventListener('input', function () {
                    clearTimeout(t);
                    t = setTimeout(function () { form.submit(); }, 450);
                }, { passive: true });
            }
        });
    })();
</script>
{% endblock %}