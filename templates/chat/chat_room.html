{% extends 'base.html' %}

{% block title %}{{ room.name }} - Chat Room - Noctis Pro PACS{% endblock %}

{% block extra_css %}
<style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-surface: #252525;
            --header-bg: #333333;
            --border-color: #404040;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4444;
        }

    .chat-room-container {
        background: var(--dark-bg);
        min-height: calc(100vh - 50px);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: var(--gradient-primary);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .chat-body {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    .messages-container {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        max-height: calc(100vh - 240px);
    }

    .participants-sidebar {
        width: 300px;
        background: var(--card-bg);
        border-left: 1px solid var(--border-color);
        padding: 1rem;
    }

    .message-item {
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .message-item.own {
        border-color: rgba(0, 212, 255, 0.35);
        background: rgba(0, 212, 255, 0.06);
    }

    .message-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .message-avatar {
        background: var(--gradient-accent);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .message-sender {
        font-weight: 600;
        color: var(--text-primary);
        margin-right: 0.5rem;
    }

    .message-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .message-content {
        color: var(--text-primary);
        line-height: 1.5;
    }

    .participant-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
    }

    .participant-avatar {
        background: var(--gradient-accent);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .participant-info {
        flex: 1;
    }

    .participant-name {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.9rem;
    }

    .participant-role {
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .online-indicator {
        width: 8px;
        height: 8px;
        background: var(--success-color);
        border-radius: 50%;
        margin-left: auto;
    }

    .offline-indicator {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        margin-left: auto;
    }

    .coming-soon {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .coming-soon i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .room-info-badge {
        background: rgba(14, 165, 233, 0.2);
        color: var(--accent-color);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-left: 1rem;
    }

    .composer {
        background: rgba(255, 255, 255, 0.02);
        border-top: 1px solid var(--border-color);
        padding: 12px;
        position: sticky;
        bottom: 0;
        z-index: 50;
    }

    .composer-inner {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .composer textarea {
        resize: none;
        min-height: 40px;
        max-height: 140px;
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(64, 64, 64, 0.5);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-primary);
        font-size: 12px;
        line-height: 1.35;
    }

    .composer textarea:focus {
        outline: none;
        border-color: rgba(0, 212, 255, 0.6);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.12);
    }

    .typing-indicator {
        color: var(--text-muted);
        font-size: 10px;
        padding: 0 4px 6px;
        min-height: 14px;
    }

    @media (max-width: 992px) {
        .participants-sidebar { display: none; }
        .messages-container { max-height: calc(100vh - 220px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-room-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{% url 'chat:chat_rooms' %}" class="btn-control me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h4 class="text-white mb-0">
                        {% if room.room_type == 'direct' %}
                            <i class="fas fa-user me-2"></i>
                        {% elif room.room_type == 'facility' %}
                            <i class="fas fa-hospital me-2"></i>
                        {% elif room.room_type == 'study' %}
                            <i class="fas fa-x-ray me-2"></i>
                        {% elif room.room_type == 'general' %}
                            <i class="fas fa-users me-2"></i>
                        {% elif room.room_type == 'support' %}
                            <i class="fas fa-tools me-2"></i>
                        {% else %}
                            <i class="fas fa-comments me-2"></i>
                        {% endif %}
                        {{ room.name }}
                    </h4>
                    <p class="text-light opacity-75 mb-0">
                        {{ room.get_room_type_display }}
                        {% if room.description %} • {{ room.description }}{% endif %}
                        <span class="room-info-badge">{{ participants.count|add:1 }} member{{ participants.count|add:1|pluralize }}</span>
                    </p>
                </div>
            </div>
            <div class="d-flex align-items-center">
                {% if user_participant.role == 'admin' or user_participant.role == 'moderator' %}
                <button type="button" class="btn-control me-2" title="Room Settings">
                    <i class="fas fa-cog"></i>
                </button>
                {% endif %}
                <button type="button" class="btn-control" onclick="toggleSidebar()"   title="Toggle Participants">
                    <i class="fas fa-users"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer" data-room-id="{{ room.id }}" data-user-id="{{ user.id }}" data-username="{{ user.username|escapejs }}">
            {% if messages %}
                {% for message in messages %}
                <div class="message-item{% if message.sender_id == user.id %} own{% endif %}" data-message-id="{{ message.id }}">
                    <div class="message-header">
                        <div class="message-avatar">
                            {{ message.sender.first_name|first|default:"U" }}{{ message.sender.last_name|first|default:"" }}
                        </div>
                        <span class="message-sender">{{ message.sender.get_full_name|default:message.sender.username }}</span>
                        <span class="message-time">{{ message.created_at|date:"M d, H:i" }}</span>
                        {% if message.is_edited %}
                        <span class="badge badge-secondary ms-2">Edited</span>
                        {% endif %}
                    </div>
                    <div class="message-content">
                        {% if message.message_type == 'text' %}
                            {{ message.content|linebreaks }}
                        {% elif message.message_type == 'image' %}
                            <i class="fas fa-image me-2"></i>
                            {% if message.attachment %}
                                <img src="{{ message.attachment.url }}" alt="Image" loading="lazy" decoding="async" style="max-width: 300px; border-radius: 8px;">
                            {% else %}
                                Image attachment
                            {% endif %}
                        {% elif message.message_type == 'file' %}
                            <i class="fas fa-file me-2"></i>
                            {% if message.attachment %}
                                <a href="{{ message.attachment.url }}" class="text-accent" download>
                                    {{ message.attachment_name|default:"Download File" }}
                                </a>
                            {% else %}
                                File attachment: {{ message.attachment_name|default:"Unknown file" }}
                            {% endif %}
                        {% elif message.message_type == 'study_link' %}
                            <i class="fas fa-link me-2"></i>
                            {% if message.study_reference %}
                                <a href="{% url 'dicom_viewer:launch_study_in_desktop_viewer' message.study_reference.id %}" class="text-accent" target="_blank">
                                    Launch Desktop Viewer for: {{ message.study_reference.patient.full_name }} - {{ message.study_reference.study_date|date:"M d, Y" }}
                                </a>
                            {% endif %}
                            {% if message.content %}
                                <br>{{ message.content|linebreaks }}
                            {% endif %}
                        {% elif message.message_type == 'system' %}
                            <em class="text-muted">{{ message.content }}</em>
                        {% else %}
                            {{ message.content|linebreaks }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="coming-soon">
                    <i class="fas fa-comments"></i>
                    <h5>No messages yet</h5>
                    <p>Be the first to start the conversation in this room!</p>
                </div>
            {% endif %}
        </div>

        <!-- Participants Sidebar -->
        <div class="participants-sidebar" id="participantsSidebar">
            <h6 class="text-light mb-3">
                <i class="fas fa-users me-2"></i>Participants ({{ participants.count|add:1 }})
            </h6>
            
            <!-- Current User -->
            <div class="participant-item">
                <div class="participant-avatar">
                    {{ user.first_name|first|default:"U" }}{{ user.last_name|first|default:"" }}
                </div>
                <div class="participant-info">
                    <div class="participant-name">{{ user.get_full_name|default:user.username }} (You)</div>
                    <div class="participant-role">{{ user_participant.get_role_display }}</div>
                </div>
                <div class="online-indicator"></div>
            </div>

            <!-- Other Participants -->
            {% for participant in participants %}
            <div class="participant-item">
                <div class="participant-avatar">
                    {{ participant.user.first_name|first|default:"U" }}{{ participant.user.last_name|first|default:"" }}
                </div>
                <div class="participant-info">
                    <div class="participant-name">{{ participant.user.get_full_name|default:participant.user.username }}</div>
                    <div class="participant-role">{{ participant.get_role_display }}</div>
                </div>
                {% if participant.is_online %}
                    <div class="online-indicator" title="Online"></div>
                {% else %}
                    <div class="offline-indicator" title="Last seen {{ participant.last_seen|timesince }} ago"></div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Room Actions -->
            <div class="mt-4">
                <h6 class="text-light mb-2">Room Actions</h6>
                {% if user_participant.role == 'admin' %}
                <button type="button" class="btn-control w-100 mb-2">
                    <i class="fas fa-user-plus me-2"></i>Invite Users
                </button>
                <button type="button" class="btn-control w-100 mb-2">
                    <i class="fas fa-cog me-2"></i>Room Settings
                </button>
                {% endif %}
                <a href="{% url 'chat:leave_room' room.id %}" class="btn-control w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>Leave Room
                </a>
            </div>
        </div>
    </div>

    <!-- Message Composer -->
    <div class="composer">
        <div class="typing-indicator" id="typingIndicator"></div>
        <div class="composer-inner">
            <textarea id="chatInput" placeholder="Type a message… (Enter to send, Shift+Enter for newline)"></textarea>
            <button type="button" class="btn-control" id="sendBtn" title="Send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('participantsSidebar');
    if (sidebar.style.display === 'none') {
        sidebar.style.display = 'block';
    } else {
        sidebar.style.display = 'none';
    }
}

// Auto-scroll to bottom of messages
function scrollToBottom() {
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Scroll to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
});

// Real-time chat via WebSocket (Channels)
(function () {
    function ready(fn) {
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
        else fn();
    }

    function wsUrl(path) {
        var proto = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';
        return proto + window.location.host + path;
    }

    function esc(s) {
        return (s || '').toString().replace(/[&<>"']/g, function (c) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
        });
    }

    function initials(name) {
        var s = (name || '').trim();
        if (!s) return 'U';
        return s.slice(0, 2).toUpperCase();
    }

    function formatTime(iso) {
        try {
            var d = new Date(iso);
            return d.toLocaleString(undefined, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            return '';
        }
    }

    ready(function () {
        var container = document.getElementById('messagesContainer');
        var input = document.getElementById('chatInput');
        var sendBtn = document.getElementById('sendBtn');
        var typingEl = document.getElementById('typingIndicator');
        if (!container || !input || !sendBtn) return;

        var roomId = container.getAttribute('data-room-id');
        var currentUserId = parseInt(container.getAttribute('data-user-id') || '0', 10);
        var currentUsername = container.getAttribute('data-username') || '';

        var socket;
        var typingTimer;
        var typingActive = false;
        var lastTypingFrom = null;

        function appendMessage(evt) {
            var isOwn = (evt.user_id === currentUserId);
            var wrapper = document.createElement('div');
            wrapper.className = 'message-item' + (isOwn ? ' own' : '');
            wrapper.setAttribute('data-message-id', evt.message_id || '');

            var senderLabel = isOwn ? 'You' : (evt.username || 'User');
            wrapper.innerHTML =
                '<div class="message-header">' +
                    '<div class="message-avatar">' + esc(initials(evt.username)) + '</div>' +
                    '<span class="message-sender">' + esc(senderLabel) + '</span>' +
                    '<span class="message-time">' + esc(formatTime(evt.timestamp)) + '</span>' +
                '</div>' +
                '<div class="message-content">' + esc(evt.message || '').replace(/\n/g, '<br>') + '</div>';

            container.appendChild(wrapper);
            scrollToBottom();
        }

        function setConnectedUi(connected) {
            sendBtn.disabled = !connected;
            input.disabled = !connected;
            input.placeholder = connected ? 'Type a message… (Enter to send, Shift+Enter for newline)' : 'Connecting…';
        }

        function connect() {
            try {
                socket = new WebSocket(wsUrl('/ws/chat/' + roomId + '/'));
            } catch (e) {
                setConnectedUi(false);
                return;
            }

            setConnectedUi(false);
            socket.onopen = function () {
                setConnectedUi(true);
                try { socket.send(JSON.stringify({ type: 'mark_read' })); } catch(e) {}
            };

            socket.onmessage = function (e) {
                var data;
                try { data = JSON.parse(e.data); } catch (err) { return; }
                if (!data || !data.type) return;

                if (data.type === 'chat_message') {
                    appendMessage(data);
                    return;
                }
                if (data.type === 'typing_indicator') {
                    if (data.is_typing) {
                        lastTypingFrom = data.username || 'Someone';
                        typingEl.textContent = lastTypingFrom + ' is typing…';
                    } else {
                        typingEl.textContent = '';
                    }
                    return;
                }
            };

            socket.onclose = function () {
                setConnectedUi(false);
                // retry with backoff-ish delay
                setTimeout(connect, 1500);
            };
        }

        function sendMessage() {
            var text = (input.value || '').trim();
            if (!text || !socket || socket.readyState !== 1) return;
            try {
                socket.send(JSON.stringify({ type: 'message', message: text }));
                input.value = '';
                input.style.height = '';
                if (typingActive) {
                    typingActive = false;
                    socket.send(JSON.stringify({ type: 'typing', is_typing: false }));
                }
            } catch (e) {}
        }

        function autoGrow() {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 140) + 'px';
        }

        sendBtn.addEventListener('click', function () { sendMessage(); });
        input.addEventListener('input', function () {
            autoGrow();
            if (!socket || socket.readyState !== 1) return;
            if (!typingActive) {
                typingActive = true;
                try { socket.send(JSON.stringify({ type: 'typing', is_typing: true })); } catch(e) {}
            }
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                if (!socket || socket.readyState !== 1) return;
                typingActive = false;
                try { socket.send(JSON.stringify({ type: 'typing', is_typing: false })); } catch(e) {}
            }, 900);
        });
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible' && socket && socket.readyState === 1) {
                try { socket.send(JSON.stringify({ type: 'mark_read' })); } catch(e) {}
            }
        });

        // initial connect
        connect();
        // if JS is disabled or socket fails, keep input disabled rather than misleading
        setConnectedUi(false);
        // prefill typing indicator empty
        if (typingEl) typingEl.textContent = '';
    });
})();
</script>
{% endblock %}