{% extends "base.html" %}

{% block title %}Chat Rooms{% endblock %}

{% block extra_css %}
<style>
    .chat-rooms-page .card-header {
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .chat-rooms-page .chat-title {
        display: flex;
        align-items: center;
        gap: 10px;
        line-height: 1.2;
    }
    .chat-rooms-page .chat-title i { color: var(--accent-color); }
    .chat-rooms-page .chat-subtitle {
        color: var(--text-muted);
        font-size: 11px;
        margin-top: 2px;
    }
    .chat-rooms-page .chat-toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .chat-rooms-page .chat-search {
        position: relative;
        min-width: 260px;
        max-width: 460px;
        flex: 1;
    }
    .chat-rooms-page .chat-search i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 12px;
        pointer-events: none;
    }
    .chat-rooms-page .chat-search input {
        padding-left: 30px;
        height: 32px;
    }
    .chat-rooms-page .chat-mini {
        color: var(--text-muted);
        font-size: 10px;
        white-space: nowrap;
    }
    .chat-rooms-page .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 14px;
    }
    .chat-rooms-page .room-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(64, 64, 64, 0.35);
        border-radius: 12px;
        padding: 14px;
        cursor: pointer;
        transition: all 0.15s ease;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .chat-rooms-page .room-card:hover {
        border-color: rgba(0, 212, 255, 0.35);
        box-shadow: 0 8px 22px rgba(0,0,0,0.22);
        transform: translateY(-1px);
    }
    .chat-rooms-page .room-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .chat-rooms-page .room-icon {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-bg);
        font-size: 15px;
        font-weight: 800;
        flex-shrink: 0;
    }
    .chat-rooms-page .type-direct { background: var(--success-color); }
    .chat-rooms-page .type-facility { background: var(--warning-color); }
    .chat-rooms-page .type-study { background: var(--accent-color); }
    .chat-rooms-page .type-general { background: var(--accent-color); }
    .chat-rooms-page .type-support { background: var(--danger-color); }
    .chat-rooms-page .room-name {
        font-size: 13px;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.2;
    }
    .chat-rooms-page .room-desc {
        font-size: 11px;
        color: var(--text-secondary);
        margin: 2px 0 0 0;
    }
    .chat-rooms-page .room-preview {
        margin-top: 10px;
        font-size: 11px;
        color: var(--text-secondary);
        min-height: 16px;
    }
    .chat-rooms-page .room-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid rgba(64, 64, 64, 0.25);
        gap: 10px;
    }
    .chat-rooms-page .unread-badge {
        background: rgba(255, 68, 68, 0.9);
        color: #fff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 800;
        min-width: 28px;
        text-align: center;
    }
    .chat-rooms-page .invite-card {
        border: 1px solid rgba(255, 170, 0, 0.35);
        background: rgba(255, 170, 0, 0.06);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 14px;
    }
    .chat-rooms-page .empty-state {
        text-align: center;
        padding: 44px 20px;
        border: 1px dashed rgba(64, 64, 64, 0.55);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.015);
        color: var(--text-secondary);
    }
    .chat-rooms-page .empty-state i {
        font-size: 44px;
        margin-bottom: 12px;
        opacity: 0.25;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 chat-rooms-page">
    <div class="card">
        <div class="card-header">
            <div class="chat-title">
                <i class="fas fa-comments" aria-hidden="true"></i>
                <div>
                    <div style="font-weight:700;">Chat</div>
                    <div class="chat-subtitle">Rooms you’re in, invitations, and suggested public rooms</div>
                </div>
            </div>
            <div class="chat-toolbar">
                <div class="chat-search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input id="chatRoomSearch" type="text" class="form-control form-control-sm" placeholder="Search rooms…" autocomplete="off" />
                </div>
                <div class="chat-mini"><span id="chatRoomCount"></span></div>
                <button type="button" class="btn-control" data-bs-toggle="modal" data-bs-target="#createRoomModal">
                    <i class="fas fa-plus"></i> Create room
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if pending_invitations %}
            <div class="invite-card">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <i class="fas fa-envelope" style="color: var(--warning-color);" aria-hidden="true"></i>
                    <div style="font-weight:800;">Pending invitations</div>
                </div>
                {% for invitation in pending_invitations %}
                <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
                    <div style="color: var(--text-secondary); font-size: 11px;">
                        <strong style="color: var(--text-primary);">{{ invitation.invited_by.get_full_name|default:invitation.invited_by.username }}</strong>
                        invited you to <strong style="color: var(--text-primary);">“{{ invitation.room.name }}”</strong>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <form method="post" action="{% url 'chat:accept_invitation' invitation.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-control"><i class="fas fa-check"></i> Accept</button>
                        </form>
                        <form method="post" action="{% url 'chat:decline_invitation' invitation.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-control"><i class="fas fa-times"></i> Decline</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="rooms-grid" id="roomsGrid">
                {% for room in user_rooms %}
                <div class="room-card chat-room-row" data-room-name="{{ room.name|lower }}" data-room-url="{% url 'chat:chat_room' room.id %}">
                    <div>
                        <div class="room-header">
                            <div class="room-icon type-{{ room.room_type }}">
                                {% if room.room_type == 'direct' %}
                                    <i class="fas fa-user" aria-hidden="true"></i>
                                {% elif room.room_type == 'facility' %}
                                    <i class="fas fa-hospital" aria-hidden="true"></i>
                                {% elif room.room_type == 'study' %}
                                    <i class="fas fa-x-ray" aria-hidden="true"></i>
                                {% elif room.room_type == 'general' %}
                                    <i class="fas fa-users" aria-hidden="true"></i>
                                {% elif room.room_type == 'support' %}
                                    <i class="fas fa-tools" aria-hidden="true"></i>
                                {% else %}
                                    <i class="fas fa-comments" aria-hidden="true"></i>
                                {% endif %}
                            </div>
                            <div style="min-width:0;">
                                <div class="room-name">{{ room.name }}</div>
                                <div class="room-desc">{{ room.get_room_type_display }}{% if room.description %} • {{ room.description|truncatechars:60 }}{% endif %}</div>
                            </div>
                        </div>

                        {% if room.latest_message %}
                        <div class="room-preview">
                            <strong style="color: var(--text-primary);">
                                {{ room.latest_message.sender.get_full_name|default:room.latest_message.sender.username }}:
                            </strong>
                            {% if room.latest_message.message_type == 'text' %}
                                {{ room.latest_message.content|truncatechars:70 }}
                            {% elif room.latest_message.message_type == 'image' %}
                                <i class="fas fa-image" aria-hidden="true"></i> Image
                            {% elif room.latest_message.message_type == 'file' %}
                                <i class="fas fa-file" aria-hidden="true"></i> {{ room.latest_message.attachment_name|default:"File" }}
                            {% elif room.latest_message.message_type == 'study_link' %}
                                <i class="fas fa-link" aria-hidden="true"></i> Study link
                            {% else %}
                                {{ room.latest_message.content|truncatechars:70 }}
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="room-preview" style="color: var(--text-muted);">No messages yet</div>
                        {% endif %}
                    </div>

                    <div class="room-footer">
                        <span style="color: var(--text-muted); font-size: 10px;">
                            {{ room.participant_count }} member{{ room.participant_count|pluralize }}
                        </span>
                        {% if room.unread_count %}
                        <span class="unread-badge" title="Unread messages">{{ room.unread_count }}</span>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div style="grid-column: 1 / -1;">
                    <div class="empty-state">
                        <i class="fas fa-comments" aria-hidden="true"></i>
                        <div style="font-size: 14px; margin-bottom: 6px; font-weight: 800;">No chat rooms yet</div>
                        <div style="font-size: 12px;">Create a room to start messaging.</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if available_rooms %}
            <div style="margin-top: 18px;">
                <div style="display:flex;align-items:center;gap:10px;margin: 6px 0 10px;">
                    <i class="fas fa-globe" style="color: var(--accent-color);" aria-hidden="true"></i>
                    <div style="font-weight:800;">Suggested public rooms</div>
                    <div class="chat-subtitle" style="margin:0;">Join to connect with other users</div>
                </div>
                <div class="rooms-grid">
                    {% for room in available_rooms %}
                    <div class="room-card chat-room-row" data-room-name="{{ room.name|lower }}" data-room-url="{% url 'chat:join_room' room.id %}">
                        <div>
                            <div class="room-header">
                                <div class="room-icon type-general"><i class="fas fa-globe" aria-hidden="true"></i></div>
                                <div style="min-width:0;">
                                    <div class="room-name">{{ room.name }}</div>
                                    <div class="room-desc">{{ room.description|default:"Public room" }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="room-footer">
                            <span style="color: var(--text-muted); font-size: 10px;">
                                {{ room.participant_count }} member{{ room.participant_count|pluralize }}
                            </span>
                            <button type="button" class="btn-control join-public" data-url="{% url 'chat:join_room' room.id %}">
                                <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Join
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Room Modal -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" style="color: var(--text-primary);"><i class="fas fa-plus"></i> Create chat room</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'chat:create_room' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label" style="color: var(--text-secondary); font-size: 11px;">Room name</label>
                            <input name="name" class="form-control" placeholder="e.g. CT Triage" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label" style="color: var(--text-secondary); font-size: 11px;">Room type</label>
                            <select name="room_type" class="form-control">
                                <option value="general">General Discussion</option>
                                <option value="facility">Facility Discussion</option>
                                <option value="study">Study Discussion</option>
                                <option value="support">Technical Support</option>
                                <option value="direct">Direct Message</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label" style="color: var(--text-secondary); font-size: 11px;">Description (optional)</label>
                            <input name="description" class="form-control" placeholder="What is this room for?">
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="roomPrivate" name="is_private">
                                <label class="form-check-label" for="roomPrivate" style="color: var(--text-secondary); font-size: 11px;">
                                    Private room (invite required)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn-control" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-control"><i class="fas fa-save"></i> Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        function normalize(s) { return (s || '').toString().toLowerCase().trim(); }
        function ready(fn) {
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
            else fn();
        }

        ready(function () {
            var search = document.getElementById('chatRoomSearch');
            var countEl = document.getElementById('chatRoomCount');
            var grid = document.getElementById('roomsGrid');
            if (!grid) return;
            var rows = Array.prototype.slice.call(document.querySelectorAll('.chat-room-row'));

            function updateCount(visible, total) {
                if (!countEl) return;
                countEl.textContent = 'Showing ' + visible + ' of ' + total;
            }

            function applyFilter() {
                var q = search ? normalize(search.value) : '';
                var visible = 0;
                rows.forEach(function (el) {
                    var hay = normalize(el.getAttribute('data-room-name')) + ' ' + normalize(el.innerText || el.textContent);
                    var show = !q || hay.indexOf(q) !== -1;
                    el.style.display = show ? '' : 'none';
                    if (show) visible += 1;
                });
                updateCount(visible, rows.length);
            }

            document.addEventListener('click', function (e) {
                var joinBtn = e.target && (e.target.closest ? e.target.closest('.join-public') : null);
                if (joinBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    var url = joinBtn.getAttribute('data-url');
                    if (url) window.location.href = url;
                    return;
                }
                var card = e.target && (e.target.closest ? e.target.closest('.chat-room-row') : null);
                if (!card) return;
                var url = card.getAttribute('data-room-url');
                if (url) window.location.href = url;
            });

            if (search) search.addEventListener('input', applyFilter, { passive: true });
            applyFilter();
        });
    })();
</script>
{% endblock %}