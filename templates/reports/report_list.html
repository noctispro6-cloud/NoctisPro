{% extends 'base.html' %}

{% block title %}Reports - Noctis Pro PACS{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        padding: 16px 0;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    .stat-icon {
        background: var(--accent-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-bg);
        font-size: 16px;
    }

    .stat-content h3 {
        color: var(--text-primary);
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 4px 0;
    }

    .stat-content p {
        color: var(--text-secondary);
        font-size: 11px;
        margin: 0;
    }

    .patient-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    .patient-id, .timestamp {
        font-family: 'Courier New', monospace;
        color: var(--text-muted);
        font-size: 10px;
    }

    .patient-id { color: var(--accent-color); }

    .modality-badge {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: bold;
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 9px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .status-draft { background: rgba(156, 163, 175, 0.2); color: #9ca3af; border: 1px solid #9ca3af; }
    .status-preliminary { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }
    .status-final { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }

    .action-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .btn-viewer {
        background: var(--accent-color);
        border: none;
        color: var(--primary-bg);
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 2px;
        white-space: nowrap;
    }

    .btn-viewer:hover { background: #00b8d4; }

    .btn-viewer.viewer-only {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-viewer.viewer-only:hover {
        background: var(--text-secondary);
        color: var(--primary-bg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="text-white mb-1"><i class="fas fa-file-medical me-2"></i>Reports</h1>
            <div class="text-secondary">Radiology reports list and quick actions</div>
        </div>
    </div>

    <form class="controls-bar" id="reportFiltersForm" method="get" action="">
        <div class="control-group">
            <label class="control-label">Search:</label>
            <input
                type="text"
                class="control-input"
                id="searchInput"
                name="search"
                value="{{ search_query|default:'' }}"
                placeholder="Patient, Accession, Radiologist..."
            >
        </div>
        <div class="control-group">
            <label class="control-label">Status:</label>
            <select class="control-select" id="statusFilter" name="status">
                <option value="">All Status</option>
                <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                <option value="preliminary" {% if status_filter == 'preliminary' %}selected{% endif %}>Preliminary</option>
                <option value="final" {% if status_filter == 'final' %}selected{% endif %}>Final</option>
                <option value="amended" {% if status_filter == 'amended' %}selected{% endif %}>Amended</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Modality:</label>
            <select class="control-select" id="modalityFilter" name="modality">
                <option value="">All Modalities</option>
                <option value="CT" {% if modality_filter == 'CT' %}selected{% endif %}>CT</option>
                <option value="MR" {% if modality_filter == 'MR' %}selected{% endif %}>MR</option>
                <option value="XR" {% if modality_filter == 'XR' %}selected{% endif %}>X-Ray</option>
                <option value="US" {% if modality_filter == 'US' %}selected{% endif %}>Ultrasound</option>
            </select>
        </div>
        <button type="submit" class="btn-control reset">REFRESH</button>
        <button type="button" class="btn-control" onclick="resetFilters()">RESET FILTERS</button>
    </form>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-file-medical"></i></div>
            <div class="stat-content">
                <h3>{{ total_reports|default:0 }}</h3>
                <p>Total Reports</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-edit"></i></div>
            <div class="stat-content">
                <h3>{{ draft_reports|default:0 }}</h3>
                <p>Draft Reports</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-content">
                <h3>{{ pending_reports|default:0 }}</h3>
                <p>Pending Review</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-content">
                <h3>{{ final_reports|default:0 }}</h3>
                <p>Final Reports</p>
            </div>
        </div>
    </div>

    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable">PATIENT</th>
                    <th class="sortable">STUDY DATE</th>
                    <th class="sortable">MODALITY</th>
                    <th class="sortable">BODY PART</th>
                    <th class="sortable">RADIOLOGIST</th>
                    <th class="sortable">STATUS</th>
                    <th class="sortable">REPORT DATE</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="reportsTableBody">
                {% if reports %}
                {% for report in reports %}
                <tr onclick="selectReport(this)" data-report-id="{{ report.id }}">
                    <td>
                        <div class="patient-name">{{ report.study.patient.full_name }}</div>
                        <div class="patient-id">{{ report.study.patient.patient_id }}</div>
                    </td>
                    <td class="timestamp">{{ report.study.study_date|date:"M d, Y" }}</td>
                    <td><span class="modality-badge">{{ report.study.modality.code }}</span></td>
                    <td>{{ report.study.body_part_examined|default:"-" }}</td>
                    <td>{{ report.radiologist.get_full_name }}</td>
                    <td>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.get_status_display }}
                        </span>
                    </td>
                    <td class="timestamp">{{ report.report_date|date:"M d, Y H:i" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'reports:write_report' report.study.id %}" class="btn-viewer" title="View/Edit Report">
                                <i class="fas fa-edit"></i> EDIT
                            </a>
                            <a href="{% url 'reports:print_report' report.study.id %}" class="btn-viewer viewer-only" title="Print Report" target="_blank">
                                <i class="fas fa-print"></i> PRINT
                            </a>
                            <a href="{% url 'reports:export_report_pdf' report.study.id %}" class="btn-viewer viewer-only" title="Download PDF">
                                <i class="fas fa-download"></i> PDF
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-file-medical" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 14px; margin-bottom: 8px;">No reports found</div>
                        <div style="font-size: 12px;">Reports will appear here when radiologists create them for studies</div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectReport(row) {
    // Remove previous selection
    document.querySelectorAll('.data-table tbody tr').forEach(r => {
        r.style.background = '';
    });
    
    // Highlight selected row
    row.style.background = 'rgba(0, 212, 255, 0.15)';
    
    console.log('Selected report:', row.getAttribute('data-report-id'));
}

function applyFilters() {
    // Server-side filtering via GET parameters (reports/views.py already supports this)
    const form = document.getElementById('reportFiltersForm');
    if (form) form.submit();
}

function resetFilters() {
    // Clear query params entirely (clean reset)
    window.location.href = "{% url 'reports:report_list' %}";
}

// Debounced auto-submit for a snappy UX without reloading on every keystroke
(function () {
    const form = document.getElementById('reportFiltersForm');
    const searchEl = document.getElementById('searchInput');
    const statusEl = document.getElementById('statusFilter');
    const modalityEl = document.getElementById('modalityFilter');
    if (!form || !searchEl || !statusEl || !modalityEl) return;

    let t = null;
    function debouncedSubmit() {
        window.clearTimeout(t);
        t = window.setTimeout(() => form.submit(), 350);
    }

    searchEl.addEventListener('input', function () {
        const v = (searchEl.value || '').trim();
        // Submit when cleared, or when meaningful input exists
        if (v.length === 0 || v.length >= 2) debouncedSubmit();
    });
    statusEl.addEventListener('change', () => form.submit());
    modalityEl.addEventListener('change', () => form.submit());
})();
</script>
{% endblock %}