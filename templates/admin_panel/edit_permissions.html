{% extends 'base.html' %}
{% load dicts %}

{% block title %}Edit Permissions - {{ user_obj.username }}{% endblock %}

{% block extra_css %}
<style>
    .perm-edit .card-header {
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .perm-edit .perm-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .perm-edit .perm-title i {
        color: var(--accent-color);
    }
    .perm-edit .perm-subtitle {
        color: var(--text-muted);
        font-size: 11px;
        margin-top: 2px;
    }
    .perm-edit .perm-toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .perm-edit .perm-search {
        position: relative;
        min-width: 260px;
        max-width: 420px;
        flex: 1;
    }
    .perm-edit .perm-search i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 12px;
        pointer-events: none;
    }
    .perm-edit .perm-search input {
        padding-left: 30px;
        height: 32px;
    }
    .perm-edit .perm-mini {
        color: var(--text-muted);
        font-size: 10px;
        white-space: nowrap;
    }
    .perm-edit .perm-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid rgba(64, 64, 64, 0.35);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
    }
    .perm-edit .perm-actions .btn-control {
        padding: 6px 12px;
    }
    .perm-edit .perm-grid-item {
        border: 1px solid rgba(64, 64, 64, 0.28);
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
        padding: 10px 12px;
        transition: background 0.15s ease, border-color 0.15s ease;
    }
    .perm-edit .perm-grid-item:hover {
        background: rgba(0, 212, 255, 0.05);
        border-color: rgba(0, 212, 255, 0.25);
    }
    .perm-edit .form-check-input {
        cursor: pointer;
    }
    .perm-edit .perm-key {
        font-weight: 700;
        letter-spacing: 0.3px;
    }
    .perm-edit .perm-raw {
        color: var(--text-muted);
        font-size: 10px;
        margin-top: 2px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 perm-edit">
    <div class="card">
        <div class="card-header">
            <div>
                <div class="perm-title">
                    <i class="fas fa-sliders-h" aria-hidden="true"></i>
                    <div>
                        <div style="font-weight:700;">Edit permissions</div>
                        <div class="perm-subtitle">User: <span style="color: var(--text-primary); font-weight: 700;">{{ user_obj.username }}</span></div>
                    </div>
                </div>
            </div>
            <div class="perm-toolbar">
                <div class="perm-search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input id="permCapSearch" type="text" class="form-control form-control-sm" placeholder="Search capabilitiesâ€¦" autocomplete="off" />
                </div>
                <div class="perm-mini"><span id="permCapCount"></span></div>
                <a class="btn-control" href="{% url 'admin_panel:permissions_dashboard' %}"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="perm-actions">
                    <button type="button" class="btn-control" id="permSelectAll"><i class="fas fa-check-double"></i> Select all</button>
                    <button type="button" class="btn-control" id="permClearAll"><i class="fas fa-eraser"></i> Clear</button>
                    <button type="button" class="btn-control" id="permInvert"><i class="fas fa-exchange-alt"></i> Invert</button>
                    <div style="flex: 1;"></div>
                    <button type="submit" class="btn-control"><i class="fas fa-save"></i> Save</button>
                </div>
                <div class="row">
                    {% for k in cap_keys %}
                    <div class="col-12 col-md-6 col-xl-4 mb-2 perm-cap-item" data-cap="{{ k|lower }}">
                        <div class="perm-grid-item">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input perm-cap-checkbox" role="switch" id="cap_{{ forloop.counter }}" name="{{ k }}" {% if caps|get_item:k %}checked{% endif %}>
                                <label class="form-check-label" for="cap_{{ forloop.counter }}">
                                    <div class="perm-key">{{ k|upper }}</div>
                                    <div class="perm-raw">{{ k }}</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        function normalize(s) {
            return (s || "").toString().toLowerCase().trim();
        }

        function ready(fn) {
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", fn);
            } else {
                fn();
            }
        }

        ready(function () {
            var search = document.getElementById("permCapSearch");
            var countEl = document.getElementById("permCapCount");
            var items = Array.prototype.slice.call(document.querySelectorAll(".perm-cap-item"));
            var boxes = Array.prototype.slice.call(document.querySelectorAll(".perm-cap-checkbox"));

            function updateCount(visible, total) {
                if (!countEl) return;
                countEl.textContent = "Showing " + visible + " of " + total + " capabilities";
            }

            function applyFilter() {
                var q = search ? normalize(search.value) : "";
                var visible = 0;
                items.forEach(function (el) {
                    var hay = normalize(el.getAttribute("data-cap")) + " " + normalize(el.innerText || el.textContent);
                    var show = !q || hay.indexOf(q) !== -1;
                    el.style.display = show ? "" : "none";
                    if (show) visible += 1;
                });
                updateCount(visible, items.length);
            }

            function setAll(checked) {
                boxes.forEach(function (b) { b.checked = checked; });
            }

            function invertAll() {
                boxes.forEach(function (b) { b.checked = !b.checked; });
            }

            var btnAll = document.getElementById("permSelectAll");
            var btnNone = document.getElementById("permClearAll");
            var btnInvert = document.getElementById("permInvert");
            if (btnAll) btnAll.addEventListener("click", function () { setAll(true); });
            if (btnNone) btnNone.addEventListener("click", function () { setAll(false); });
            if (btnInvert) btnInvert.addEventListener("click", invertAll);
            if (search) search.addEventListener("input", applyFilter, { passive: true });

            applyFilter();
        });
    })();
</script>
{% endblock %}

