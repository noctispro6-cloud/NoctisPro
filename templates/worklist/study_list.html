{% extends "base.html" %}
{% load dicts %}
{% load static %}

{% block title %}Studies - Noctis Pro PACS{% endblock %}

{% block extra_css %}
<style>
	.filters {
		display: grid;
		grid-template-columns: repeat(5, minmax(160px, 1fr));
		gap: 10px;
		margin-bottom: 12px;
	}

	.filters .btn-control { align-self: end; }

	.table-card {
		background: var(--card-bg);
		border: 1px solid var(--border-color);
		border-radius: 12px;
		overflow: hidden;
	}

	.table-card table { width: 100%; }

	.table-card th {
		background: var(--header-bg);
		color: var(--text-secondary);
		text-transform: uppercase;
		font-size: 12px;
		padding: 10px;
		border-bottom: 1px solid var(--border-color);
	}

	.table-card td {
		padding: 10px;
		border-bottom: 1px solid var(--border-color);
		vertical-align: top;
	}

	.badge-mod {
		display: inline-block;
		padding: 2px 8px;
		border: 1px solid var(--accent-color);
		border-radius: 999px;
		font-size: 11px;
		color: var(--accent-color);
	}

	.status-pill {
		padding: 2px 8px;
		border-radius: 999px;
		font-size: 11px;
		border: 1px solid var(--border-color);
		color: var(--text-secondary);
	}

	.priority-pill {
		padding: 2px 8px;
		border-radius: 999px;
		font-size: 11px;
		border: 1px solid var(--border-color);
		color: var(--text-secondary);
		display: inline-flex;
		align-items: center;
		gap: 6px;
	}
	.priority-urgent { border-color: var(--urgent-color); color: var(--urgent-color); }
	.priority-high { border-color: var(--warning-color); color: var(--warning-color); }
	.priority-normal { border-color: var(--accent-color); color: var(--accent-color); }
	.priority-low { border-color: var(--text-muted); color: var(--text-muted); }
	.ai-flag { border-color: var(--accent-color); color: var(--accent-color); }

	.attachments, .prev-reports {
		display: flex;
		gap: 6px;
		flex-wrap: wrap;
	}

	.attachment-chip {
		border: 1px solid var(--border-color);
		border-radius: 999px;
		padding: 2px 8px;
		font-size: 11px;
		color: var(--text-secondary);
		background: rgba(255,255,255,0.03);
		text-decoration: none;
	}

	.attachment-chip i { margin-right: 6px; }

	.search-input { position: relative; }

	.search-input input {
		width: 100%;
		background: var(--secondary-bg);
		border: 1px solid var(--border-color);
		color: var(--text-primary);
		border-radius: 8px;
		padding: 8px 12px;
	}

	.form-select {
		background: var(--secondary-bg);
		border: 1px solid var(--border-color);
		color: var(--text-primary);
		border-radius: 8px;
		padding: 8px 12px;
	}

	.empty {
		text-align: center;
		color: var(--text-secondary);
		padding: 24px;
	}

	.pagination-dark .page-link {
		background: var(--card-bg);
		border-color: var(--border-color);
		color: var(--text-primary);
	}

	.pagination-dark .page-link:hover {
		background: var(--accent-color);
		color: var(--primary-bg);
	}

	.pagination-dark .page-item.active .page-link {
		background: var(--accent-color);
		border-color: var(--accent-color);
		color: var(--primary-bg);
	}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
	{# Provide a real CSRF token for JS actions (e.g. delete) #}
	<form style="display:none">{% csrf_token %}</form>
	<div class="filters">
		<div class="search-input"><input type="text" id="search" placeholder="Search patient, accession, description…" value="{{ search_query|default:'' }}"></div>
		<select id="status" class="form-select form-control-medical">
			<option value="">All Status</option>
			<option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Scheduled</option>
			<option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
			<option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
			<option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
		</select>
		<select id="priority" class="form-select form-control-medical">
			<option value="">All Priority</option>
			<option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
			<option value="normal" {% if priority_filter == 'normal' %}selected{% endif %}>Normal</option>
			<option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
			<option value="urgent" {% if priority_filter == 'urgent' %}selected{% endif %}>Urgent</option>
		</select>
		<select id="modality" class="form-select form-control-medical">
			<option value="">All Modalities</option>
			{% for m in modalities %}
			<option value="{{ m.code }}" {% if modality_filter == m.code %}selected{% endif %}>{{ m.code }}</option>
			{% endfor %}
		</select>
		<button type="button" class="btn-control" id="applyFilters" title="Apply Filters"><i class="fas fa-filter"></i></button>
	</div>

	<div class="table-card">
		<table class="table table-dark table-hover mb-0">
			<thead>
				<tr>
					<th>Patient</th>
					<th>Accession</th>
					<th>Study Date</th>
					<th>Mod</th>
					<th>Status</th>
					<th>Priority / AI</th>
					<th>Attachments</th>
					<th>Previous Reports</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
			{% for s in studies %}
			<tr>
				<td>
					<div class="d-flex align-items-center justify-content-between">
						<div class="fw-bold">{{ s.patient.full_name }}</div>
						<a class="btn-control" href="{% url 'worklist:upload_attachment' s.id %}" title="Attach files for {{ s.patient.full_name }}">
							<i class="fas fa-paperclip"></i>
						</a>
					</div>
					<div class="text-secondary small">{{ s.patient.patient_id }}</div>
				</td>
				<td class="accession">{{ s.accession_number }}</td>
				<td>{{ s.study_date|date:"M d, Y H:i" }}</td>
				<td><span class="badge-mod">{{ s.modality.code }}</span></td>
				<td><span class="status-pill">{{ s.status|title }}</span></td>
				<td>
					<span class="priority-pill priority-{{ s.priority|default:'normal' }}">
						<i class="fas fa-flag"></i> {{ s.priority|default:'normal'|title }}
					</span>
					{% with t=ai_triage_map|get_item:s.id %}
						{% if t and t|get_item:'flagged' %}
							<span class="priority-pill ai-flag" title="AI flagged this study (triage {{ t|get_item:'triage_level' }} score {{ t|get_item:'triage_score' }})" style="margin-left:6px;">
								<i class="fas fa-robot"></i> AI {{ t|get_item:'triage_level'|default:'high'|upper }}
							</span>
						{% endif %}
					{% endwith %}
				</td>
				<td>
					<div class="attachments">
						{% for a in attachments_map|get_item:s.id %}
							<a class="attachment-chip" href="{% url 'worklist:view_attachment' a.id %}" title="View attachment">
								{% if a.file_type == 'dicom_study' %}<i class="fas fa-cubes"></i>{% elif a.file_type == 'pdf_document' %}<i class="fas fa-file-pdf"></i>{% elif a.file_type == 'image' %}<i class="fas fa-image"></i>{% else %}<i class="fas fa-paperclip"></i>{% endif %}
								{{ a.name|truncatechars:24 }}
							</a>
						{% empty %}
							<span class="text-secondary">None</span>
						{% endfor %}
					</div>
				</td>
				<td>
					<div class="prev-reports">
						{% for r in previous_reports_map|get_item:s.id %}
							<a class="attachment-chip" href="{% url 'reports:write_report' r.study.id %}" title="{{ r.get_status_display }} by {{ r.radiologist.get_full_name }}">
								<i class="fas fa-file-medical"></i>{{ r.status|title }} {{ r.report_date|date:"Y-m-d" }}
							</a>
						{% empty %}
							<span class="text-secondary">None</span>
						{% endfor %}
					</div>
				</td>
				<td>
					<div class="d-flex gap-2">
						<!-- View Study Detail - All authenticated users -->
						<a class="btn-control" href="{% url 'worklist:study_detail' s.id %}" title="Open"><i class="fas fa-folder-open"></i></a>
						
						<!-- DICOM Viewer - All authenticated users -->
						<a class="btn-dicom-viewer btn-sm" href="{% url 'dicom_viewer:viewer' %}?study={{ s.id }}" onclick="openStudyInViewer('{{ s.id }}', event); return false;" title="View in DICOM Viewer"><i class="fas fa-eye"></i></a>
						
						<!-- Report Writing - Only admin and radiologist -->
						{% if user.role == 'admin' or user.role == 'radiologist' %}
						<a class="btn-control" href="{% url 'reports:write_report' s.id %}" title="Report"><i class="fas fa-file-medical"></i></a>
						{% endif %}
						
						<!-- Delete Study - Only admin and radiologist -->
						{% if user.role == 'admin' or user.role == 'radiologist' %}
						<button type="button" class="btn-control" style="background: var(--danger-color);" 
								onclick="deleteStudy({{ s.id }}, '{{ s.accession_number|escapejs }}')" 
								title="Delete Study (Admin/Radiologist Only)">
							<i class="fas fa-trash"></i>
						</button>
						{% endif %}
					</div>
				</td>
			</tr>
			{% empty %}
			<tr><td colspan="9" class="empty">No studies</td></tr>
			{% endfor %}
			</tbody>
		</table>
	</div>

	{% if studies.has_other_pages %}
	<nav aria-label="Studies pagination" class="mt-3">
		<ul class="pagination pagination-dark justify-content-center">
			{% if studies.has_previous %}
			<li class="page-item"><a class="page-link" href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if modality_filter %}&modality={{ modality_filter }}{% endif %}">«</a></li>
			<li class="page-item"><a class="page-link" href="?page={{ studies.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if modality_filter %}&modality={{ modality_filter }}{% endif %}">‹</a></li>
			{% endif %}
			{% for num in studies.paginator.page_range %}
				{% if studies.number == num %}
				<li class="page-item active"><span class="page-link">{{ num }}</span></li>
				{% elif num > studies.number|add:'-3' and num < studies.number|add:'3' %}
				<li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if modality_filter %}&modality={{ modality_filter }}{% endif %}">{{ num }}</a></li>
				{% endif %}
			{% endfor %}
			{% if studies.has_next %}
			<li class="page-item"><a class="page-link" href="?page={{ studies.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if modality_filter %}&modality={{ modality_filter }}{% endif %}">›</a></li>
			<li class="page-item"><a class="page-link" href="?page={{ studies.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if modality_filter %}&modality={{ modality_filter }}{% endif %}">»</a></li>
			{% endif %}
		</ul>
	</nav>
	{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/worklist-button-handlers.js' %}" defer></script>
<script>
	// Notification count update (page-level fallback; base.html also updates notif badges)
	(function(){
		async function updateUnread(){
			try {
				const res = await fetch('{% url "notifications:api_unread_count" %}', { credentials: 'same-origin' });
				if (!res.ok) return;
				const data = await res.json();
				const count = (data && (data.unread || data.count || data.unread_count)) || 0;
				const el = document.getElementById('notifBadge');
				if (el) {
					if (count > 0) {
						el.textContent = count;
						el.style.display = '';
					} else {
						el.style.display = 'none';
					}
				}
			} catch(e) { /* ignore */ }
		}
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', updateUnread);
		} else { updateUnread(); }
		setInterval(updateUnread, 30000);
	})();

	// Filter functionality
	(function(){
		function go(){
			const p = new URLSearchParams();
			const q = document.getElementById('search').value.trim(); if (q) p.set('search', q);
			const s = document.getElementById('status').value; if (s) p.set('status', s);
			const pr = document.getElementById('priority').value; if (pr) p.set('priority', pr);
			const m = document.getElementById('modality').value; if (m) p.set('modality', m);
			location.search = p.toString();
		}
		document.getElementById('applyFilters').addEventListener('click', go);
		document.getElementById('search').addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); go(); }});
	})();

	// Delete study functionality (admin/radiologist only)
	async function deleteStudy(studyId, accessionNumber) {
		if (!confirm(`Are you sure you want to delete study ${accessionNumber}?\n\nThis action cannot be undone and will permanently remove all associated data including:\n• DICOM images\n• Series data\n• Reports\n• Measurements\n• Annotations`)) {
			return;
		}

		try {
			const csrfToken =
				document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
				document.querySelector('meta[name=csrf-token]')?.getAttribute('content');

			const response = await fetch(`/worklist/api/study/${studyId}/delete/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrfToken || '',
					'X-Requested-With': 'XMLHttpRequest'
				},
				credentials: 'same-origin'
			});

			const data = await response.json();

			if (response.ok && data.success) {
				alert(`Study ${accessionNumber} deleted successfully`);
				location.reload();
			} else {
				alert(`Failed to delete study: ${data.error || 'Unknown error'}`);
			}
		} catch (error) {
			console.error('Error deleting study:', error);
			alert(`Failed to delete study: ${error.message}`);
		}
	}
</script>
{% endblock %}